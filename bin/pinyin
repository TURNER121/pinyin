#!/usr/bin/env php
<?php

require __DIR__ . '/../vendor/autoload.php';

use tekintian\pinyin\PinyinConverter;

// å‘½ä»¤è¡Œé€‰é¡¹å®šä¹‰
$options = [
    'separator' => ' ',           // åˆ†éš”ç¬¦
    'with-tone' => false,         // æ˜¯å¦å¸¦å£°è°ƒ
    'mode' => 'delete',           // ç‰¹æ®Šå­—ç¬¦å¤„ç†æ¨¡å¼: delete/keep/replace
    'slug' => false,              // æ˜¯å¦ç”ŸæˆURL Slug
    'json' => false,              // æ˜¯å¦è¾“å‡ºJSONæ ¼å¼
    'compact' => false,           // æ˜¯å¦å‹ç¼©JSONè¾“å‡º
    'add-custom' => null,         // æ·»åŠ è‡ªå®šä¹‰æ‹¼éŸ³: æ±‰å­—:æ‹¼éŸ³
    'remove-custom' => null,      // åˆ é™¤è‡ªå®šä¹‰æ‹¼éŸ³: æ±‰å­—
    'merge-self-learn' => false,  // æ‰§è¡Œè‡ªå­¦ä¹ å­—å…¸åˆå¹¶
    'help' => false               // æ˜¾ç¤ºå¸®åŠ©
];

$help = <<<"HELP"
æ±‰å­—è½¬æ‹¼éŸ³å‘½ä»¤è¡Œå·¥å…· (åŸºäº PinyinConverter)

ç”¨æ³•:
    ./pinyin "æ–‡æœ¬å†…å®¹" [é€‰é¡¹]

åŸºæœ¬è½¬æ¢:
    ./pinyin "ä½ å¥½ä¸–ç•Œ"                    # æ— å£°è°ƒè½¬æ¢
    ./pinyin "ä½ å¥½ä¸–ç•Œ" --with-tone         # å¸¦å£°è°ƒè½¬æ¢
    ./pinyin "ä½ å¥½ä¸–ç•Œ" -s "-"              # ä½¿ç”¨è¿å­—ç¬¦åˆ†éš”
    ./pinyin "ä½ å¥½ä¸–ç•Œ" --slug              # ç”ŸæˆURL Slug

ç‰¹æ®Šå­—ç¬¦å¤„ç†:
    ./pinyin "ä½ å¥½ï¼ä¸–ç•Œ"                   # é»˜è®¤åˆ é™¤ç‰¹æ®Šå­—ç¬¦
    ./pinyin "ä½ å¥½ï¼ä¸–ç•Œ" --mode keep       # ä¿ç•™ç‰¹æ®Šå­—ç¬¦
    ./pinyin "ä½ å¥½ï¼ä¸–ç•Œ" --mode replace    # æ›¿æ¢ç‰¹æ®Šå­—ç¬¦

è‡ªå®šä¹‰å­—å…¸ç®¡ç†:
    ./pinyin --add-custom="å¥½:hao"          # æ·»åŠ è‡ªå®šä¹‰æ‹¼éŸ³ï¼ˆæ— å£°è°ƒï¼‰
    ./pinyin --add-custom="å¥½:hÇo" --with-tone # æ·»åŠ å¸¦å£°è°ƒè‡ªå®šä¹‰æ‹¼éŸ³
    ./pinyin --remove-custom="å¥½"           # åˆ é™¤è‡ªå®šä¹‰æ‹¼éŸ³

è‡ªå­¦ä¹ åŠŸèƒ½:
    ./pinyin --merge-self-learn            # æ‰§è¡Œè‡ªå­¦ä¹ å­—å…¸åˆå¹¶

è¾“å‡ºæ ¼å¼:
    ./pinyin "ä½ å¥½ä¸–ç•Œ" --json              # JSONæ ¼å¼è¾“å‡º
    ./pinyin "ä½ å¥½ä¸–ç•Œ" --json --compact    # å‹ç¼©JSONè¾“å‡º

é€‰é¡¹è¯´æ˜:
    -s, --separator=SEP        åˆ†éš”ç¬¦ (é»˜è®¤: ç©ºæ ¼)
    -t, --with-tone            å¸¦å£°è°ƒè½¬æ¢
    -m, --mode=MODE            ç‰¹æ®Šå­—ç¬¦å¤„ç†æ¨¡å¼: delete/keep/replace (é»˜è®¤: delete)
    -u, --slug                 ç”ŸæˆURL Slug
    -j, --json                 JSONæ ¼å¼è¾“å‡º
    -c, --compact              å‹ç¼©JSONè¾“å‡º
    -a, --add-custom=CHAR:PY   æ·»åŠ è‡ªå®šä¹‰æ‹¼éŸ³
    -r, --remove-custom=CHAR   åˆ é™¤è‡ªå®šä¹‰æ‹¼éŸ³
    --merge-self-learn         æ‰§è¡Œè‡ªå­¦ä¹ å­—å…¸åˆå¹¶
    -h, --help                æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯

ç¤ºä¾‹:
    ./pinyin "Vue3å¼€å‘ä¼ä¸šçº§AIæœåŠ¡" --with-tone
    ./pinyin "äº‘å—çœæ˜†æ˜å¸‚" --slug
    ./pinyin "ä½ å¥½ï¼@#ä¸–ç•Œ" --mode keep
    ./pinyin --add-custom="ç³»:xi" --add-custom="æœ¯:shu"
HELP;

// è§£æå‘½ä»¤è¡Œå‚æ•°
function parseArguments($argv) {
    global $options;
    
    $inputText = '';
    $args = [];
    
    for ($i = 1; $i < count($argv); $i++) {
        $arg = $argv[$i];
        
        if (strpos($arg, '--') === 0) {
            // é•¿é€‰é¡¹
            $parts = explode('=', substr($arg, 2), 2);
            $key = $parts[0];
            $value = $parts[1] ?? true;
            
            if (isset($options[$key])) {
                $options[$key] = $value;
            }
        } elseif (strpos($arg, '-') === 0) {
            // çŸ­é€‰é¡¹
            $key = substr($arg, 1);
            if (strlen($key) > 1 && strpos($key, '=') !== false) {
                $parts = explode('=', $key, 2);
                $key = $parts[0];
                $value = $parts[1];
            } else {
                $value = true;
            }
            
            // æ˜ å°„çŸ­é€‰é¡¹åˆ°é•¿é€‰é¡¹
            $mapping = [
                's' => 'separator',
                't' => 'with-tone',
                'm' => 'mode',
                'u' => 'slug',
                'j' => 'json',
                'c' => 'compact',
                'a' => 'add-custom',
                'r' => 'remove-custom',
                'h' => 'help'
            ];
            
            if (isset($mapping[$key])) {
                $options[$mapping[$key]] = $value;
            }
        } else {
            // è¾“å…¥æ–‡æœ¬
            if (empty($inputText)) {
                $inputText = $arg;
            } else {
                $inputText .= ' ' . $arg;
            }
        }
    }
    
    return $inputText;
}

// ä¸»ç¨‹åº
function main($argv) {
    global $options, $help;
    
    $inputText = parseArguments($argv);
    
    // æ˜¾ç¤ºå¸®åŠ©
    if ($options['help'] || (empty($inputText) && !$options['add-custom'] && !$options['remove-custom'] && !$options['merge-self-learn'])) {
        echo $help;
        exit(0);
    }
    
    // åˆ›å»ºè½¬æ¢å™¨å®ä¾‹
    $converter = new PinyinConverter();
    
    // å¤„ç†è‡ªå®šä¹‰å­—å…¸æ“ä½œ
    if ($options['add-custom']) {
        $parts = explode(':', $options['add-custom'], 2);
        if (count($parts) === 2) {
            $char = trim($parts[0]);
            $pinyin = trim($parts[1]);
            $converter->addCustomPinyin($char, $pinyin, $options['with-tone']);
            echo "âœ… å·²æ·»åŠ è‡ªå®šä¹‰æ‹¼éŸ³: {$char} â†’ {$pinyin}\n";
        } else {
            echo "âŒ æ— æ•ˆçš„è‡ªå®šä¹‰æ‹¼éŸ³æ ¼å¼ï¼Œè¯·ä½¿ç”¨ æ±‰å­—:æ‹¼éŸ³ æ ¼å¼\n";
            exit(1);
        }
        exit(0);
    }
    
    if ($options['remove-custom']) {
        $char = trim($options['remove-custom']);
        $converter->removeCustomPinyin($char, $options['with-tone']);
        echo "âœ… å·²åˆ é™¤è‡ªå®šä¹‰æ‹¼éŸ³: {$char}\n";
        exit(0);
    }
    
    // å¤„ç†è‡ªå­¦ä¹ å­—å…¸åˆå¹¶
    if ($options['merge-self-learn']) {
        $result = $converter->executeMerge();
        echo "ğŸ“Š è‡ªå­¦ä¹ å­—å…¸åˆå¹¶å®Œæˆ:\n";
        echo "   æˆåŠŸåˆå¹¶: " . implode(', ', $result['success']) . "\n";
        if (!empty($result['fail'])) {
            echo "   å¤±è´¥é¡¹ç›®: " . count($result['fail']) . "\n";
            foreach ($result['fail'] as $fail) {
                echo "     - {$fail['toneType']}: {$fail['error']}\n";
            }
        }
        exit(0);
    }
    
    // æ‰§è¡Œæ‹¼éŸ³è½¬æ¢
    if (!empty($inputText)) {
        if ($options['slug']) {
            // URL Slug æ¨¡å¼
            $result = $converter->getUrlSlug($inputText, $options['separator']);
        } else {
            // æ™®é€šè½¬æ¢æ¨¡å¼
            $specialCharParam = $options['mode'] === 'replace' 
                ? ['mode' => 'replace', 'map' => []] 
                : $options['mode'];
            
            $result = $converter->convert(
                $inputText,
                $options['separator'],
                $options['with-tone'],
                $specialCharParam
            );
        }
        
        // è¾“å‡ºç»“æœ
        if ($options['json']) {
            $jsonOptions = JSON_UNESCAPED_UNICODE;
            if (!$options['compact']) {
                $jsonOptions |= JSON_PRETTY_PRINT;
            }
            
            $output = [
                'input' => $inputText,
                'output' => $result,
                'options' => [
                    'separator' => $options['separator'],
                    'with_tone' => $options['with-tone'],
                    'mode' => $options['mode'],
                    'is_slug' => $options['slug']
                ]
            ];
            
            echo json_encode($output, $jsonOptions) . "\n";
        } else {
            echo $result . "\n";
        }
    }
}

// æ‰§è¡Œä¸»ç¨‹åº
main($argv);
