# 字典路径配置指南

## 概述

拼音转换器支持通过环境变量 `PINYIN_DICT_ROOT_PATH` 自定义字典文件的根路径，这在使用项目作为包时特别有用。

## 环境变量配置

### PINYIN_DICT_ROOT_PATH

设置字典文件的根路径。如果不设置，默认使用项目目录下的 `data` 目录。

```bash
# 使用绝对路径（推荐用于生产环境）
export PINYIN_DICT_ROOT_PATH=/usr/local/share/pinyin-data

# 使用相对路径（适用于开发环境）
export PINYIN_DICT_ROOT_PATH=./dict_data

# 容器化部署
export PINYIN_DICT_ROOT_PATH=/data/pinyin/dicts
```

## 字典文件结构

字典根目录下应包含以下文件和目录：

```
dict_root_path/
├── common_with_tone.php      # 常用字带声调字典
├── common_no_tone.php        # 常用字无声调字典
├── rare_with_tone.php        # 生僻字带声调字典
├── rare_no_tone.php          # 生僻字无声调字典
├── custom_with_tone.php      # 自定义带声调字典
├── custom_no_tone.php        # 自定义无声调字典
├── self_learn_with_tone.php  # 自学习带声调字典
├── self_learn_no_tone.php    # 自学习无声调字典
├── polyphone_rules.php       # 多音字规则
├── char_frequency.php        # 字符频率统计
├── unihan/                  # Unihan扩展字典
│   ├── cjk_ext_a.php
│   └── cjk_ext_a_no_tone.php
├── diy/                     # 自定义文件
│   └── not_found_chars.php
└── backup/                  # 备份和日志目录
    ├── migration_log.json
    ├── self_learn_sources.json
    └── immediate_merge_log.json
```

## 部署字典文件

### 使用部署脚本

项目提供了便捷的部署脚本 `tools/deploy_dicts.php`：

```bash
# 将字典文件部署到系统目录
php tools/deploy_dicts.php /usr/local/share/pinyin-data

# 部署到当前目录的 dict_data 文件夹
php tools/deploy_dicts.php ./dict_data

# 部署到容器挂载目录
php tools/deploy_dicts.php /data/pinyin/dicts
```

### 手动部署

```bash
# 创建目标目录
mkdir -p /usr/local/share/pinyin-data

# 复制字典文件
cp -r data/* /usr/local/share/pinyin-data/

# 设置适当的权限
chmod -R 644 /usr/local/share/pinyin-data/*.php
chmod -R 755 /usr/local/share/pinyin-data/backup
```

## 使用场景

### 1. 作为 Composer 包使用

当将此项目作为 Composer 包发布时，建议：

```bash
# 1. 部署字典到系统共享目录
php tools/deploy_dicts.php /usr/local/share/pinyin-data

# 2. 设置环境变量
export PINYIN_DICT_ROOT_PATH=/usr/local/share/pinyin-data

# 3. 在应用中使用
use tekintian\pinyin\PinyinConverter;

$converter = new PinyinConverter();
// 字典文件将从 /usr/local/share/pinyin-data 加载
```

### 2. 开发环境

```bash
# 使用项目本地的字典目录
export PINYIN_DICT_ROOT_PATH=./dev_dicts

# 或使用默认配置（不设置环境变量）
# 字典将从项目 data 目录加载
```

### 3. 生产环境

```bash
# 集中管理字典文件
export PINYIN_DICT_ROOT_PATH=/var/lib/pinyin/dicts

# 确保目录存在且有正确权限
mkdir -p /var/lib/pinyin/dicts/backup
chown -R www-data:www-data /var/lib/pinyin/dicts
chmod -R 755 /var/lib/pinyin/dicts
```

### 4. 容器化部署

Dockerfile 示例：

```dockerfile
# 复制字典文件到容器
COPY data/ /data/pinyin/dicts/

# 设置环境变量
ENV PINYIN_DICT_ROOT_PATH=/data/pinyin/dicts

# 确保目录权限正确
RUN mkdir -p /data/pinyin/dicts/backup && \
    chmod -R 755 /data/pinyin/dicts
```

docker-compose.yml 示例：

```yaml
version: '3.8'
services:
  app:
    image: my-php-app
    environment:
      - PINYIN_DICT_ROOT_PATH=/data/pinyin/dicts
    volumes:
      - ./pinyin-data:/data/pinyin/dicts
```

## 配置验证

### 检查字典路径

```php
use tekintian\pinyin\PinyinConverter;

$converter = new PinyinConverter();

// 获取当前字典根路径
$dictRootPath = $converter->getDictRootPath();
echo "字典根路径: " . $dictRootPath . "\n";

// 检查关键文件是否存在
$commonDictPath = $dictRootPath . '/common_with_tone.php';
echo "常用字典存在: " . (file_exists($commonDictPath) ? '是' : '否') . "\n";
```

### 测试转换功能

```php
$converter = new PinyinConverter();

// 测试基本转换
$result = $converter->convert('你好世界');
echo "转换结果: " . $result . "\n";

// 如果转换失败，可能是字典路径配置问题
if (empty($result)) {
    echo "警告: 字典转换失败，请检查字典路径配置\n";
}
```

## 故障排除

### 常见问题

1. **文件权限错误**
   ```bash
   # 确保字典文件可读
   chmod -R 644 /path/to/dicts/*.php
   chmod -R 755 /path/to/dicts/backup
   ```

2. **路径不存在**
   ```bash
   # 检查路径是否存在
   ls -la $PINYIN_DICT_ROOT_PATH
   
   # 如果不存在，使用部署脚本
   php tools/deploy_dicts.php $PINYIN_DICT_ROOT_PATH
   ```

3. **环境变量未生效**
   ```bash
   # 检查环境变量
   echo $PINYIN_DICT_ROOT_PATH
   
   # 在 PHP 中检查
   echo getenv('PINYIN_DICT_ROOT_PATH');
   ```

### 调试技巧

```php
// 启用调试模式查看字典加载情况
$converter = new PinyinConverter([
    'debug' => true
]);

// 查看当前配置
$config = $converter->getConfig();
print_r($config['dict_root_path']);
```

## 最佳实践

1. **生产环境**: 使用绝对路径，确保路径稳定
2. **开发环境**: 使用相对路径，便于项目移植
3. **容器化**: 使用挂载卷，便于字典文件更新
4. **包发布**: 提供默认字典路径，支持自定义配置
5. **权限管理**: 确保字典文件可读，备份目录可写

## 相关配置

字典路径配置与其他环境变量的配合：

| 环境变量 | 作用 | 推荐组合 |
|---------|------|---------|
| `PINYIN_DICT_ROOT_PATH` | 字典根路径 | `/usr/local/share/pinyin-data` |
| `PINYIN_DICT_STRATEGY` | 加载策略 | `both` |
| `PINYIN_DICT_CACHE_SIZE` | 缓存大小 | `2000` |
| `PINYIN_LAZY_LOADING` | 懒加载 | `true` |

通过合理配置这些环境变量，可以在不同场景下获得最佳的性能和灵活性。